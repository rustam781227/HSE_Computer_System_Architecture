     1                                  ; file.asm - использование файлов в NASM
     2                                  extern printf
     3                                  extern fscanf
     4                                  
     5                                  
     6                                  extern RECTANGLE
     7                                  extern TRIANGLE
     8                                  extern CIRCLE
     9                                  
    10                                  
    11                                  global InRectangle
    12                                  InRectangle:
    13                                  section .data
    14 00000000 256425642564256400          .infmt1 db "%d%d%d%d",0
    15 00000009 256400                      .infmt2 db "%d",0
    16                                  section .bss
    17 00000000 <res 00000008>              .FILE   resq    1   
    18 00000008 <res 00000008>              .rect  resq     1 
    19                                  section .text
    20 00000000 55                      push rbp
    21 00000001 4889E5                  mov rbp, rsp
    22                                      
    23 00000004 48893C25[08000000]          mov     [.rect], rdi          
    24 0000000C 48893425[00000000]          mov     [.FILE], rsi         
    25                                   
    26 00000014 488B3C25[00000000]          mov     rdi, [.FILE]
    27 0000001C 48BE-                       mov     rsi, .infmt1         
    27 0000001E [0000000000000000] 
    28 00000026 488B1425[08000000]          mov     rdx, [.rect]       
    29 0000002E 488B0C25[08000000]          mov     rcx, [.rect]
    30 00000036 4883C104                    add     rcx, 4              
    31 0000003A 4C8B0425[08000000]          mov     r8, [.rect]
    32 00000042 4983C008                    add     r8, 8              
    33 00000046 4C8B0C25[08000000]          mov     r9, [.rect]
    34 0000004E 4983C10C                    add     r9, 12 
    35 00000052 B800000000                  mov     rax, 0              
    36 00000057 E8(00000000)                call    fscanf
    37                                      
    38 0000005C 488B3C25[00000000]          mov     rdi, [.FILE]
    39 00000064 48BE-                       mov     rsi, .infmt2         
    39 00000066 [0900000000000000] 
    40 0000006E 488B1425[08000000]          mov     rdx, [.rect]
    41 00000076 4883C210                    add     rdx, 16       
    42 0000007A B800000000                  mov     rax, 0              
    43 0000007F E8(00000000)                call    fscanf
    44                                  
    45 00000084 C9                      leave
    46 00000085 C3                      ret
    47                                  
    48                                  
    49                                  global InTriangle
    50                                  InTriangle:
    51                                  section .data
    52 0000000C 256425642564256400          .infmt1 db "%d%d%d%d",0
    53 00000015 25642564256400              .infmt2 db "%d%d%d",0
    54                                  section .bss
    55 00000010 <res 00000008>              .FILE   resq    1   ; временное хранение указателя на файл
    56 00000018 <res 00000008>              .trian  resq    1   ; адрес треугольника
    57                                  section .text
    58 00000086 55                      push rbp
    59 00000087 4889E5                  mov rbp, rsp
    60                                  
    61                                      ; Сохранение принятых аргументов
    62 0000008A 48893C25[18000000]          mov     [.trian], rdi          ; сохраняется адрес треугольника
    63 00000092 48893425[10000000]          mov     [.FILE], rsi          ; сохраняется указатель на файл
    64                                  
    65                                      ; Ввод треугольника из файла
    66 0000009A 488B3C25[10000000]          mov     rdi, [.FILE]
    67 000000A2 48BE-                       mov     rsi, .infmt1         ; Формат - 1-й аргумент
    67 000000A4 [0C00000000000000] 
    68 000000AC 488B1425[18000000]          mov     rdx, [.trian]       ; &a
    69 000000B4 488B0C25[18000000]          mov     rcx, [.trian]
    70 000000BC 4883C104                    add     rcx, 4              ; &b = &a + 4
    71 000000C0 4C8B0425[18000000]          mov     r8, [.trian]
    72 000000C8 4983C008                    add     r8, 8               ; &c = &x + 8
    73 000000CC 4C8B0C25[18000000]          mov     r9, [.trian]
    74 000000D4 4983C10C                    add     r9, 12
    75 000000D8 B800000000                  mov     rax, 0              ; нет чисел с плавающей точкой
    76 000000DD E8(00000000)                call    fscanf
    77                                  
    78 000000E2 488B3C25[10000000]          mov     rdi, [.FILE]
    79 000000EA 48BE-                       mov     rsi, .infmt2        ; Формат - 1-й аргумент
    79 000000EC [1500000000000000] 
    80 000000F4 488B1425[18000000]          mov     rdx, [.trian]       ; &a
    81 000000FC 4883C210                    add     rdx, 16
    82 00000100 488B0C25[18000000]          mov     rcx, [.trian]
    83 00000108 4883C114                    add     rcx, 20              ; &b = &a + 4
    84 0000010C 4C8B0425[18000000]          mov     r8, [.trian]
    85 00000114 4983C018                    add     r8, 24               ; &c = &x + 8
    86 00000118 B800000000                  mov     rax, 0              ; нет чисел с плавающей точкой
    87 0000011D E8(00000000)                call    fscanf
    88                                  
    89 00000122 C9                      leave
    90 00000123 C3                      ret
    91                                  
    92                                  global InCircle
    93                                  InCircle:
    94                                  section .data
    95 0000001C 256425642564256400          .infmt db "%d%d%d%d",0
    96                                  section .bss
    97 00000020 <res 00000008>              .FILE   resq    1   ; временное хранение указателя на файл
    98 00000028 <res 00000008>              .circ  resq    1   ; адрес треугольника
    99                                  section .text
   100 00000124 55                      push rbp
   101 00000125 4889E5                  mov rbp, rsp
   102                                  
   103                                      ; Сохранение принятых аргументов
   104 00000128 48893C25[28000000]          mov     [.circ], rdi          ; сохраняется адрес треугольника
   105 00000130 48893425[20000000]          mov     [.FILE], rsi          ; сохраняется указатель на файл
   106                                  
   107                                      ; Ввод треугольника из файла
   108 00000138 488B3C25[20000000]          mov     rdi, [.FILE]
   109 00000140 48BE-                       mov     rsi, .infmt         ; Формат - 1-й аргумент
   109 00000142 [1C00000000000000] 
   110 0000014A 488B1425[28000000]          mov     rdx, [.circ]       ; &a
   111 00000152 488B0C25[28000000]          mov     rcx, [.circ]
   112 0000015A 4883C104                    add     rcx, 4              ; &b = &a + 4
   113 0000015E 4C8B0425[28000000]          mov     r8, [.circ]
   114 00000166 4983C008                    add     r8, 8               ; &c = &x + 8
   115 0000016A 4C8B0C25[28000000]          mov     r9, [.circ]
   116 00000172 4983C10C                    add     r9, 12
   117 00000176 B800000000                  mov     rax, 0              ; нет чисел с плавающей точкой
   118 0000017B E8(00000000)                call    fscanf
   119                                  
   120 00000180 C9                      leave
   121 00000181 C3                      ret
   122                                  
   123                                  
   124                                  global InShape
   125                                  InShape:
   126                                  section .data
   127 00000025 256400                      .tagFormat   db      "%d",0
   128 00000028 5461672069733A2025-         .tagOutFmt   db     "Tag is: %d",10,0
   128 00000031 640A00             
   129                                  section .bss
   130 00000030 <res 00000008>              .FILE       resq    1   ; временное хранение указателя на файл
   131 00000038 <res 00000008>              .pshape     resq    1   ; адрес фигуры
   132 00000040 <res 00000004>              .shapeTag   resd    1   ; признак фигуры
   133                                  section .text
   134 00000182 55                      push rbp
   135 00000183 4889E5                  mov rbp, rsp
   136                                  
   137                                      ; Сохранение принятых аргументов
   138 00000186 48893C25[38000000]          mov     [.pshape], rdi          ; сохраняется адрес фигуры
   139 0000018E 48893425[30000000]          mov     [.FILE], rsi            ; сохраняется указатель на файл
   140                                  
   141                                      ; чтение признака фигуры и его обработка
   142 00000196 488B3C25[30000000]          mov     rdi, [.FILE]
   143 0000019E 48BE-                       mov     rsi, .tagFormat
   143 000001A0 [2500000000000000] 
   144 000001A8 488B1425[38000000]          mov     rdx, [.pshape]      ; адрес начала фигуры (ее признак)
   145 000001B0 4831C0                      xor     rax, rax            ; нет чисел с плавающей точкой
   146 000001B3 E8(00000000)                call    fscanf
   147                                  
   148                                  
   149 000001B8 488B0C25[38000000]          mov rcx, [.pshape]          ; загрузка адреса начала фигуры
   150 000001C0 8B01                        mov eax, [rcx]              ; и получение прочитанного признака
   151 000001C2 3B0425[00000000]            cmp eax, [RECTANGLE]
   152 000001C9 7416                        je .rectIn
   153 000001CB 3B0425[00000000]            cmp eax, [TRIANGLE]
   154 000001D2 742D                        je .trianIn
   155 000001D4 3B0425[00000000]            cmp eax, [CIRCLE]
   156 000001DB 7444                        je .circIn
   157 000001DD 31C0                        xor eax, eax    ; Некорректный признак - обнуление кода возврата
   158 000001DF EB60                        jmp     .return
   159                                  .rectIn:
   160                                      ; Ввод прямоугольника
   161 000001E1 488B3C25[38000000]          mov     rdi, [.pshape]
   162 000001E9 4883C704                    add     rdi, 4
   163 000001ED 488B3425[30000000]          mov     rsi, [.FILE]
   164 000001F5 E806FEFFFF                  call    InRectangle
   165 000001FA B801000000                  mov     rax, 1  ; Код возврата - true
   166 000001FF EB40                        jmp     .return
   167                                  .trianIn:
   168                                      ; Ввод треугольника
   169 00000201 488B3C25[38000000]          mov     rdi, [.pshape]
   170 00000209 4883C704                    add     rdi, 4
   171 0000020D 488B3425[30000000]          mov     rsi, [.FILE]
   172 00000215 E86CFEFFFF                  call    InTriangle
   173 0000021A B801000000                  mov     rax, 1  ; Код возврата - true
   174 0000021F EB20                        jmp     .return
   175                                  .circIn:
   176                                      ; Ввод треугольника
   177 00000221 488B3C25[38000000]          mov     rdi, [.pshape]
   178 00000229 4883C704                    add     rdi, 4
   179 0000022D 488B3425[30000000]          mov     rsi, [.FILE]
   180 00000235 E8EAFEFFFF                  call    InCircle
   181 0000023A B801000000                  mov     rax, 1  ; Код возврата - true
   182 0000023F EB00                        jmp     .return
   183                                  .return:
   184                                  
   185 00000241 C9                      leave
   186 00000242 C3                      ret
   187                                  
   188                                  
   189                                  global InContainer
   190                                  InContainer:
   191                                  section .bss
   192 00000044 <res 00000008>              .pcont  resq    1   ; адрес контейнера
   193 0000004C <res 00000008>              .plen   resq    1   ; адрес для сохранения числа введенных элементов
   194 00000054 <res 00000008>              .FILE   resq    1   ; указатель на файл
   195                                  section .text
   196 00000243 55                      push rbp
   197 00000244 4889E5                  mov rbp, rsp
   198                                  
   199 00000247 48893C25[44000000]          mov [.pcont], rdi   ; сохраняется указатель на контейнер
   200 0000024F 48893425[4C000000]          mov [.plen], rsi    ; сохраняется указатель на длину
   201 00000257 48891425[54000000]          mov [.FILE], rdx    ; сохраняется указатель на файл
   202                                      ; В rdi адрес начала контейнера
   203 0000025F 4831DB                      xor rbx, rbx        ; число фигур = 0
   204 00000262 4889D6                      mov rsi, rdx        ; перенос указателя на файл
   205                                  .loop:
   206                                      ; сохранение рабочих регистров
   207 00000265 57                          push rdi
   208 00000266 53                          push rbx
   209                                  
   210 00000267 488B3425[54000000]          mov     rsi, [.FILE]
   211 0000026F B800000000                  mov     rax, 0      ; нет чисел с плавающей точкой
   212 00000274 E809FFFFFF                  call    InShape     ; ввод фигуры
   213 00000279 4883F800                    cmp rax, 0          ; проверка успешности ввода
   214 0000027D 7E0B                        jle  .return        ; выход, если признак меньше или равен 0
   215                                  
   216 0000027F 5B                          pop rbx
   217 00000280 48FFC3                      inc rbx
   218                                  
   219 00000283 5F                          pop rdi
   220 00000284 4883C720                    add rdi, 32             ; адрес следующей фигуры
   221                                  
   222 00000288 EBDB                        jmp .loop
   223                                  .return:
   224 0000028A 488B0425[4C000000]          mov rax, [.plen]    ; перенос указателя на длину
   225 00000292 8918                        mov [rax], ebx      ; занесение длины
   226 00000294 C9                      leave
   227 00000295 C3                      ret
   228                                  
